# GitHub Actions - æ„å»ºå¹¶åŒæ­¥ Mihomo å¢å¼ºé•œåƒ
# åŠŸèƒ½ï¼š
# 1. åŸºäºä¸Šæ¸¸ Mihomo é•œåƒæ„å»ºå¢å¼ºç‰ˆï¼ˆæ·»åŠ è‡ªåŠ¨æ›´æ–°åŠŸèƒ½ï¼‰
# 2. æ¨é€åˆ° GitHub Container Registry (GHCR)
# 3. æ”¯æŒå¤šæ¶æ„æ„å»ºï¼ˆamd64/arm64ï¼‰
# 4. ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘æ„å»º

name: Build Mihomo Auto-Update Image

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºï¼ˆå³ä½¿æ²¡æœ‰å˜åŒ–ï¼‰'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  packages: write

env:
  # é•œåƒåç§°ï¼ˆå¯é€šè¿‡ secrets.TARGET_IMAGE_NAME é…ç½®ï¼Œé»˜è®¤ä¸º mihome-enhanceï¼‰
  IMAGE_NAME: ${{ secrets.TARGET_IMAGE_NAME || 'mihome-enhance' }}
  # ä¸Šæ¸¸é•œåƒ
  UPSTREAM_IMAGE: metacubex/mihomo:latest

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      # ==================== å‡†å¤‡é˜¶æ®µ ====================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      # ==================== ç™»å½•é•œåƒä»“åº“ ====================
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ==================== æå–å…ƒæ•°æ® ====================
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            # latest æ ‡ç­¾
            type=raw,value=latest
            # æ—¥æœŸæ ‡ç­¾ (20240101)
            type=schedule,pattern={{date 'YYYYMMDD'}}
            # Git SHA æ ‡ç­¾
            type=sha,prefix={{date 'YYYYMMDD'}}-
          labels: |
            org.opencontainers.image.title=Mihomo Enhance
            org.opencontainers.image.description=Mihomo docker with automatic subscription update
            org.opencontainers.image.vendor=${{ github.repository_owner }}

      # ==================== æ£€æŸ¥ä¸Šæ¸¸æ›´æ–° ====================
      - name: Check upstream image
        id: upstream
        run: |
          echo "æ£€æŸ¥ä¸Šæ¸¸é•œåƒ: ${{ env.UPSTREAM_IMAGE }}"

          # æ‹‰å–ä¸Šæ¸¸é•œåƒï¼ˆä»… manifestï¼Œä¸ä¸‹è½½å…¨éƒ¨å±‚ï¼‰
          docker pull ${{ env.UPSTREAM_IMAGE }} --quiet

          # è·å–é•œåƒ ID
          UPSTREAM_ID=$(docker inspect --format='{{.Id}}' ${{ env.UPSTREAM_IMAGE }})
          echo "upstream_id=${UPSTREAM_ID}" >> $GITHUB_OUTPUT
          echo "âœ… ä¸Šæ¸¸é•œåƒ ID: ${UPSTREAM_ID:0:12}"

          # æ£€æŸ¥æˆ‘ä»¬çš„é•œåƒæ˜¯å¦å­˜åœ¨
          OUR_IMAGE="ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest"
          if docker pull $OUR_IMAGE 2>/dev/null; then
            OUR_BASE_ID=$(docker inspect --format='{{.Config.Image}}' $OUR_IMAGE || echo "")
            echo "our_base_id=${OUR_BASE_ID}" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  å½“å‰é•œåƒåŸºäº: ${OUR_BASE_ID:0:12}"
          else
            echo "our_base_id=" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  å½“å‰é•œåƒä¸å­˜åœ¨ï¼Œå°†é¦–æ¬¡æ„å»º"
          fi

      # ==================== æ„å»ºå¹¶æ¨é€ ====================
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
            VCS_REF=${{ github.sha }}

      # ==================== è¾“å‡ºæ„å»ºä¿¡æ¯ ====================
      - name: Image digest
        run: |
          echo "=========================================="
          echo "ğŸ‰ é•œåƒæ„å»ºå®Œæˆ"
          echo "=========================================="
          echo "ğŸ“¦ é•œåƒä¿¡æ¯ï¼š"
          echo "   Digest: ${{ steps.build.outputs.digest }}"
          echo "   Tags: ${{ steps.meta.outputs.tags }}"
          echo ""
          echo "ğŸš€ ä½¿ç”¨æ–¹æ³•ï¼š"
          echo "   docker pull ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "   docker run -d \\"
          echo "     --name mihome-enhance \\"
          echo "     -e SUBSCRIBE_URL=https://your-subscription-url \\"
          echo "     -p 7890:7890 -p 9090:9090 \\"
          echo "     ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest"
          echo "=========================================="

      # ==================== æ¸…ç† ====================
      - name: Cleanup
        if: always()
        run: |
          docker system prune -f --volumes
