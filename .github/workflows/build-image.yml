# GitHub Actions - æ„å»ºå¹¶åŒæ­¥ Mihomo è‡ªåŠ¨æ›´æ–°é•œåƒ
# åŠŸèƒ½ï¼š
# 1. å®šæœŸä»ä¸Šæ¸¸åŒæ­¥æœ€æ–°çš„ Mihomo é•œåƒ
# 2. åŸºäºæœ€æ–°é•œåƒæ„å»ºå¢å¼ºç‰ˆï¼ˆæ·»åŠ è‡ªåŠ¨æ›´æ–°åŠŸèƒ½ï¼‰
# 3. æ¨é€åˆ° GitHub Container Registry (GHCR)
# 4. æ”¯æŒå¤šæ¶æ„æ„å»ºï¼ˆamd64/arm64ï¼‰

name: Build Mihomo Auto-Update Image

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯6å°æ—¶æ£€æŸ¥ä¸€æ¬¡ä¸Šæ¸¸æ›´æ–°
  schedule:
    - cron: "0 */6 * * *"

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºï¼ˆå³ä½¿æ²¡æœ‰å˜åŒ–ï¼‰'
        required: false
        type: boolean
        default: false

  # ä»£ç å˜æ›´è§¦å‘
  push:
    branches:
      - main
      - master
    paths:
      - 'Dockerfile'
      - 'scripts/**'
      - '.github/workflows/**'

  # PR è§¦å‘ï¼ˆä»…æ„å»ºæµ‹è¯•ï¼Œä¸æ¨é€ï¼‰
  pull_request:
    paths:
      - 'Dockerfile'
      - 'scripts/**'

permissions:
  contents: read
  packages: write

env:
  # é•œåƒåç§°ï¼ˆä½¿ç”¨ä»“åº“åï¼‰
  IMAGE_NAME: mihomo-auto
  # ä¸Šæ¸¸é•œåƒ
  UPSTREAM_IMAGE: metacubex/mihomo:latest

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      # ==================== å‡†å¤‡é˜¶æ®µ ====================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      # ==================== ç™»å½•é•œåƒä»“åº“ ====================
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ==================== æå–å…ƒæ•°æ® ====================
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            # latest æ ‡ç­¾
            type=raw,value=latest
            # æ—¥æœŸæ ‡ç­¾ (20240101)
            type=schedule,pattern={{date 'YYYYMMDD'}}
            # Git SHA æ ‡ç­¾
            type=sha,prefix={{date 'YYYYMMDD'}}-
            # åˆ†æ”¯æ ‡ç­¾
            type=ref,event=branch
            # PR æ ‡ç­¾
            type=ref,event=pr
          labels: |
            org.opencontainers.image.title=Mihomo Auto-Update
            org.opencontainers.image.description=Mihomo with automatic subscription update
            org.opencontainers.image.vendor=${{ github.repository_owner }}

      # ==================== æ£€æŸ¥ä¸Šæ¸¸æ›´æ–° ====================
      - name: Check upstream image
        id: upstream
        run: |
          echo "æ£€æŸ¥ä¸Šæ¸¸é•œåƒ: ${{ env.UPSTREAM_IMAGE }}"

          # æ‹‰å–ä¸Šæ¸¸é•œåƒï¼ˆä»… manifestï¼Œä¸ä¸‹è½½å…¨éƒ¨å±‚ï¼‰
          docker pull ${{ env.UPSTREAM_IMAGE }} --quiet

          # è·å–é•œåƒ ID
          UPSTREAM_ID=$(docker inspect --format='{{.Id}}' ${{ env.UPSTREAM_IMAGE }})
          echo "upstream_id=${UPSTREAM_ID}" >> $GITHUB_OUTPUT
          echo "âœ… ä¸Šæ¸¸é•œåƒ ID: ${UPSTREAM_ID:0:12}"

          # æ£€æŸ¥æˆ‘ä»¬çš„é•œåƒæ˜¯å¦å­˜åœ¨
          OUR_IMAGE="ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest"
          if docker pull $OUR_IMAGE 2>/dev/null; then
            OUR_BASE_ID=$(docker inspect --format='{{.Config.Image}}' $OUR_IMAGE || echo "")
            echo "our_base_id=${OUR_BASE_ID}" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  å½“å‰é•œåƒåŸºäº: ${OUR_BASE_ID:0:12}"
          else
            echo "our_base_id=" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  å½“å‰é•œåƒä¸å­˜åœ¨ï¼Œå°†é¦–æ¬¡æ„å»º"
          fi

      # ==================== æ„å»ºå¹¶æ¨é€ ====================
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
            VCS_REF=${{ github.sha }}

      # ==================== è¾“å‡ºæ„å»ºä¿¡æ¯ ====================
      - name: Image digest
        run: |
          echo "=========================================="
          echo "ğŸ‰ é•œåƒæ„å»ºå®Œæˆ"
          echo "=========================================="
          echo "ğŸ“¦ é•œåƒä¿¡æ¯ï¼š"
          echo "   Digest: ${{ steps.build.outputs.digest }}"
          echo "   Tags: ${{ steps.meta.outputs.tags }}"
          echo ""
          echo "ğŸš€ ä½¿ç”¨æ–¹æ³•ï¼š"
          echo "   docker pull ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "   docker run -d \\"
          echo "     --name mihomo-auto \\"
          echo "     -e SUBSCRIBE_URL=https://your-subscription-url \\"
          echo "     -v mihomo-data:/data \\"
          echo "     -p 7890:7890 -p 9090:9090 \\"
          echo "     ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest"
          echo "=========================================="

      # ==================== æµ‹è¯•é•œåƒï¼ˆå¯é€‰ï¼‰ ====================
      - name: Test image
        if: github.event_name != 'pull_request'
        run: |
          echo "ğŸ§ª æµ‹è¯•é•œåƒåŸºæœ¬åŠŸèƒ½..."

          # æ‹‰å–åˆšæ„å»ºçš„é•œåƒ
          docker pull ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest

          # æ£€æŸ¥é•œåƒæ˜¯å¦åŒ…å«å¿…è¦çš„è„šæœ¬
          docker run --rm ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest \
            sh -c 'ls -la /usr/local/bin/*.sh'

          # éªŒè¯è„šæœ¬å¯æ‰§è¡Œ
          docker run --rm ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest \
            sh -c 'test -x /usr/local/bin/entrypoint.sh && echo "âœ… entrypoint.sh å¯æ‰§è¡Œ"'

          docker run --rm ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest \
            sh -c 'test -x /usr/local/bin/update-config.sh && echo "âœ… update-config.sh å¯æ‰§è¡Œ"'

          docker run --rm ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest \
            sh -c 'test -x /usr/local/bin/update-loop.sh && echo "âœ… update-loop.sh å¯æ‰§è¡Œ"'

          echo "âœ… é•œåƒæµ‹è¯•é€šè¿‡"

      # ==================== æ¸…ç† ====================
      - name: Cleanup
        if: always()
        run: |
          docker system prune -f --volumes
