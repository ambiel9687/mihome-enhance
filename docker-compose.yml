# Docker Compose 配置 - Mihomo 自动更新
# 使用说明：
# 1. 复制此文件到您的项目目录
# 2. 根据需要修改环境变量
# 3. 运行: docker-compose up -d

version: '3.8'

services:
  mihomo:
    # 镜像配置
    image: ghcr.io/YOUR_USERNAME/mihome-enhance:latest
    container_name: mihome-enhance
    hostname: mihomo

    # 重启策略
    restart: unless-stopped

    # 环境变量配置
    environment:
      # ===== 必需配置 =====
      # 订阅地址（必填）- 提供已处理好的订阅配置URL
      - SUBSCRIBE_URL=https://your-subscription-url-here

      # ===== 可选配置 =====
      # 更新间隔（秒），默认 28800（8小时）
      - UPDATE_INTERVAL=28800

      # Socks5 起始端口，默认 42000
      - START_PORT=42000

      # Mihomo API 密钥，默认 "123456"
      - API_SECRET=123456

      # Socks5 认证（可选）
      # - AUTH_USER=your_username
      # - AUTH_PASS=your_password

      # 自定义配置名称（可选）
      # - CONFIG_NAME=my-config

      # 日志级别：debug, info, warning, error
      - LOG_LEVEL=info

      # 首次更新延迟（秒），默认 300（5分钟）
      - INITIAL_UPDATE_DELAY=300

      # 时区设置
      - TZ=Asia/Shanghai

      # 调试模式：显示完整URL（包含认证参数），用于排查网络问题
      # 警告：启用后会在日志中显示敏感信息，仅用于调试
      # - SHOW_FULL_URL=true

    # 端口映射
    ports:
      # Mixed 代理端口（HTTP + SOCKS5）
      - "7890:7890"

      # Mihomo RESTful API 端口
      - "9090:9090"

      # 如果需要映射多个 Socks5 端口，根据节点数量添加
      # 例如：起始端口 42000，有 10 个节点
      # - "42000-42009:42000-42009"

    # 网络配置
    # networks:
    #   - mihomo-network

    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/version", "-H", "Authorization: Bearer 123456"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3

    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # 资源限制（可选）
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1.0'
    #       memory: 512M
    #     reservations:
    #       cpus: '0.5'
    #       memory: 256M

# 网络定义（如果需要）
# networks:
#   mihomo-network:
#     driver: bridge
#     ipam:
#       config:
#         - subnet: 172.20.0.0/16
